"use strict";function ParseException(n){this.message=n;this.name="Fatal parser exception"}function kawaiiClarifyValue(n){if(n.match(/(?<=")(.*)(?=")/gmiu)!==null)return n.match(/(?<=")(.*)(?=")/gmiu)[0];if(n.match(/(?<=')(.*)(?=')/gmiu)!==null)return n.match(/(?<=')(.*)(?=')/gmiu)[0];if(storyScript.variables[n.replace(/ /gmiu,"")].type=="variable")return storyScript.variables[n.replace(/ /gmiu,"")].value;throw new ParseException("Error parsing input! Expected variable of type Variable, but variable of type "+storyScript.variables[n.replace(" ","")].type+" given!");}function kawaiiTypewriter(n,t,i=55){function u(){document.querySelector(t).innerHTML=n.substring(0,r);r++;r>n.length||setTimeout(function(){u()},i)}var r=0;setTimeout(function(){u()},i)}function kawaiiReadStatement(n){return/:/gmiu.test(n)?n.split(":"):[n]}function kawaiiReadActsFromString(n){var t={},i;if(n=n.replace(/\$(.)*/gmiu,"").replace(/^([\n])$/gmiu,"").replace(/^([ ]*)$/gmiu,"").replace(/\nACT/gmiu,"ACT"),i=n.split("/ACT"),i.forEach(function(n){n=n.split("\n");var i=n[0].replace(/ACT /gmui,"");n.splice(0,1);t[i]=[];n.forEach(function(n){t[i].push(kawaiiReadStatement(n))})}),typeof t.INIT=="undefined")throw new ParseException("Could not parse script! Script must contain INIT act!");return t}function kawaiiReadVariablesFromString(n){var t={};return n.forEach(function(t,i){t=t.replace(/\$/gmiu,"");n[i]=t}),n.forEach(function(n){if(n=n.split("="),n.length!==2)throw new ParseException("Invalid variable defenition!");var r=n[1].match(/.+?(?=\()/gmiu)[0],i=n[1].match(/(?<=\()(.*)(?=\))/gmiu)[0].split(",");switch(r){case"Character":if(i.length==4)t[n[0]]={type:"character",name:kawaiiClarifyValue(i[0]),color:kawaiiClarifyValue(i[1]),folder:kawaiiClarifyValue(i[2]),extension:kawaiiClarifyValue(i[3])};else throw new ParseException("Character constructor expects 4 parameters, but "+i.length+" given!");break;case"Alias":t[n[0]]={type:"alias",value:i[0].replace(/"/gmiu,"")};break;case"Variable":t[n[0]]={type:"variable",value:i[0].replace(/"/gmiu,"")};break;default:console.error("Could not parse script! Undefined data type: "+r+"!")}}),t}function kawaiiReadScriptFromString(n){return{variables:kawaiiReadVariablesFromString(n.match(/\$(.)*/gmiu)),script:kawaiiReadActsFromString(n.replace(/\$(.)*/gmiu,""))}}function kawaii(n={},t="#kawaii_default",i="",r){this.story="undefined"!=typeof r?kawaiiReadScriptFromFile(r):kawaiiReadScriptFromString(i);this.config=n;this.target=t;this.setConfig=function(n){this.config=n};this.setTargetElement=function(n){this.target=document.querySelector(n)};this.start=function(){function o(n){console.log(n);switch(n.length){case 1:if(n[0].match(/@/gmiu)==null)switch(n[0]){case"die":document.querySelector(".kawaii_container").outerHTML="";break;case"\n":i=!i;break;default:console.error("Undefined instruction occured: "+n[0]+". Allowed instructions here: @goto, @noop, @choice, @imgchoice, @halt, @background, @pause, @prompt, @move, die, save, load, exec")}else{let e=n[0].replace("@","").match(/.+?(?=\()/gmiu)[0],t=n[0].replace("@","").match(/(?<=\()(.*)(?=\))/gmiu)[0].split(",");switch(e){case"appear":document.querySelector(".kawaii_front").innerHTML+="<img id='kawaii_CHARACTERSPRITE___"+t[0]+"' src='"+r.variables[t[0]].folder+"/index."+r.variables[t[0]].extension+"' />";i=!i;u++;f();break;case"dispose":document.querySelector("#kawaii_CHARACTERSPRITE___"+t[0]).outerHTML="";i=!i;break;case"hide":document.querySelector("#kawaii_CHARACTERSPRITE___"+t[0]).style.opacity="0.000";i=!i;break;case"show":document.querySelector("#kawaii_CHARACTERSPRITE___"+t[0]).style.display="1.000";i=!i;break;case"mov":document.querySelector("#kawaii_CHARACTERSPRITE___"+t[0]).style.right=document.querySelector("#kawaii_CHARACTERSPRITE___"+t[0]).style.right+t[1]+"pt";i=!i;break;case"sprite":document.querySelector("#kawaii_CHARACTERSPRITE___"+t[0]).src=r.variables[t[0]].folder+"/"+kawaiiClarifyValue(t[1])+"."+r.variables[t[0]].extension;i=!i;break;case"background":document.querySelector(".kawaii_background").innerHTML="<img src='"+kawaiiClarifyValue(t[0])+"' alt='"+kawaiiClarifyValue(t[0])+"' />";i=!i;break;case"goto":s=kawaiiClarifyValue(t[0]);u=-1;i=!i;break;case"halt":i=i;break;case"pause":case"noop":for(;;)break;i=!i;break;case"audio":break;case"lock":window.setTimeout(function(){i=!i},t[0]);document.querySelector(".kawaii_lock").style.display="inline-block";window.setTimeout(function(){document.querySelector(".kawaii_lock").style.display="none"},t[0]);break;case"video":document.querySelector(".kawaii_background").innerHTML="<video autoplay nodownload><source src='"+t[0].match(/(?<=")(.*)(?=")/gmiu)[0]+"'><\/source><\/video>";i=!i;u++;f();break;case"choice":let e=[],o="";t.forEach(function(n){let t=[n.split("=>")[0].match(/(?<=")(.*)(?=")/gmiu)[0].replace(/\\"/gmiu,'"'),n.split("=>")[1].match(/(?<=")(.*)(?=")/gmiu)[0].replace(/\\"/gmiu,'"')];e.push(t)});e.forEach(function(n){o+='<li><em class="kawaii_select" data-code="'+btoa(n[1])+'">'+n[0]+"<\/em><\/li>"});document.querySelector(".kawaii_menu").innerHTML="<ul>"+o+"<\/ul>";document.querySelector(".kawaii_menu").style.display="initial";break;case"imgchoice":break;default:console.error("Undefined instruction occured: "+n[0]+". Allowed instructions here: @goto, @halt, @load, @noop, @choice, @pause, @prompt, @mov, @appear, @audio, @video, @sprite, die, save, load, exec")}}break;case 2:switch(n[0].replace(" ","")){case"javascript":document.querySelector(".kawaii_name").innerHTML="";kawaiiTypewriter(eval(n[1]),".kawaii_line");i=!i;break;default:if(r.variables[n[0].replace(" ","")].type=="character")document.querySelector(".kawaii_name").style.color=r.variables[n[0].replace(" ","")].color,document.querySelector(".kawaii_name").innerHTML=r.variables[n[0].replace(" ","")].name,kawaiiTypewriter(kawaiiClarifyValue(n[1]),".kawaii_line"),setTimeout(function(){i=!i},kawaiiClarifyValue(n[1]).length*65);else throw ParseException("Error parsing input! Expected variable of type Character, but variable of type "+r.variables[n[0].replace(" ","")].type+" given!");}}}function f(){i&&(i=!i,o(r.script[s][u]),u++)}let c=new AudioContext,e=btoa(n.UID),r=this.story,i=!0,s="INIT",u=-1;var h={alg:"A256CTR",ext:!0,k:"b5kAYh5q8C7Se2JnaCxRj_gaFHF7n80QY7Jdue0s5uI",key_ops:["encrypt","decrypt","wrapKey","unwrapKey"],kty:"oct"};window.crypto.subtle.importKey("jwk",{kty:"oct",k:"b5kAYh5q8C7Se2JnaCxRj_gaFHF7n80QY7Jdue0s5uI",alg:"A256CTR",ext:!0},{name:"AES-CTR"},!0,["encrypt","decrypt","wrapKey","unwrapKey"]).then(function(n){h=n});const l=openDatabase("kawaiiStorage__"+e,"1.0.0.0.0.00","kawaii Saves Storage Database (Application ID: "+e+")",9007199254740991);document.querySelector(t).outerHTML='<div class="kawaii_container" id="kawaii__'+e.replace(".","_")+'" align="left" ><div class="kawaii_viewport"><div class="kawaii_menu" style="display: none;"><\/div><div class="kawaii_background"><\/div><div class="kawaii_front" align="center"><\/div><div class="kawaii_text"><h4 class="kawaii_name"><\/h4><p class="kawaii_line"><\/p><\/div><div class="kawaii_toolbar">&nbsp;&nbsp;<strong class="kawaii_lock"><em>LOCK<\/em><\/strong><\/div><\/div>';document.querySelector(".kawaii_front").addEventListener("click",function(){f()},{capture:!0,once:!1,passive:!1,mozSystemGroup:!0},!0,!0);document.querySelector(".kawaii_menu").addEventListener("click",function(n){document.querySelector(".kawaii_menu").style.display="none";o(kawaiiReadStatement(atob(n.target.dataset.code)));f()},{capture:!0,once:!1,passive:!1,mozSystemGroup:!0},!0,!0)}}var kawaiiMeta={version:"0.0.1alpha",parserVersion:"same",release:!1}